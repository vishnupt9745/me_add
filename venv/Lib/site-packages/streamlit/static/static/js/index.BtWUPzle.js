import{r as t,E as Z,_ as K,u as Le,bb as ae,ax as ze,bt as le,L as We,k as he,n as q,b0 as ce,bn as Me,bh as Oe,bg as _e,s as C,j as d,af as Ve,e as $,B as Ne,al as He,b as je,bu as qe,l as $e,T as Ge,P as Xe,W as Ze}from"./index.CAj-7vWz.js";import{T as Ke,a as de}from"./Toolbar.D8nHCkuz.js";import{u as Je,F as Qe}from"./FormClearHelper.BB1Km6eP.js";import{c as Ye}from"./createDownloadLinkElement.ZaXNnPK4.js";import{F as er,D as rr}from"./FileDownload.esm.Ddx8VEYy.js";var pe=t.forwardRef(function(e,r){var o={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return t.createElement(Z,K({iconAttrs:o,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},e,{ref:r}),t.createElement("g",{fill:"none"},t.createElement("rect",{width:24,height:24}),t.createElement("rect",{width:24,height:24}),t.createElement("rect",{width:24,height:24})),t.createElement("path",{d:"M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"}),t.createElement("path",{d:"M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"}))});pe.displayName="Mic";var ge=t.forwardRef(function(e,r){var o={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return t.createElement(Z,K({iconAttrs:o,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},e,{ref:r}),t.createElement("rect",{width:24,height:24,fill:"none"}),t.createElement("path",{d:"M8 19c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2v10c0 1.1.9 2 2 2zm6-12v10c0 1.1.9 2 2 2s2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2z"}))});ge.displayName="Pause";var ye=t.forwardRef(function(e,r){var o={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return t.createElement(Z,K({iconAttrs:o,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},e,{ref:r}),t.createElement("rect",{width:24,height:24,fill:"none"}),t.createElement("path",{d:"M8 6.82v10.36c0 .79.87 1.27 1.54.84l8.14-5.18a1 1 0 000-1.69L9.54 5.98A.998.998 0 008 6.82z"}))});ye.displayName="PlayArrow";var ve=t.forwardRef(function(e,r){var o={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return t.createElement(Z,K({iconAttrs:o,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},e,{ref:r}),t.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),t.createElement("path",{d:"M17.65 6.35a7.95 7.95 0 00-6.48-2.31c-3.67.37-6.69 3.35-7.1 7.02C3.52 15.91 7.27 20 12 20a7.98 7.98 0 007.21-4.56c.32-.67-.16-1.44-.9-1.44-.37 0-.72.2-.88.53a5.994 5.994 0 01-6.8 3.31c-2.22-.49-4.01-2.3-4.48-4.52A6.002 6.002 0 0112 6c1.66 0 3.14.69 4.22 1.78l-1.51 1.51c-.63.63-.19 1.71.7 1.71H19c.55 0 1-.45 1-1V6.41c0-.89-1.08-1.34-1.71-.71l-.64.65z"}))});ve.displayName="Refresh";var we=t.forwardRef(function(e,r){var o={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return t.createElement(Z,K({iconAttrs:o,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},e,{ref:r}),t.createElement("g",{fill:"none"},t.createElement("rect",{width:24,height:24}),t.createElement("rect",{width:24,height:24})),t.createElement("path",{fillRule:"evenodd",d:"M9 16h6c.55 0 1-.45 1-1V9c0-.55-.45-1-1-1H9c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1zm3-14C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"}))});we.displayName="StopCircle";async function tr(e,r=16e3){if(!e||e.size===0)throw new Error("Invalid or empty blob provided");if(!window.AudioContext)throw new Error("AudioContext not supported in this browser");const o=new AudioContext;try{const n=await e.arrayBuffer(),s=await o.decodeAudioData(n),p=r??s.sampleRate,l=await nr(s,p);return or(l,p)}finally{o.close()}}async function nr(e,r){const{duration:o,numberOfChannels:n,sampleRate:s}=e,p=Math.ceil(o*r);if(!window.OfflineAudioContext)throw new Error("OfflineAudioContext not supported");const l=new OfflineAudioContext(1,p,r),v=l.createBufferSource();if(v.buffer=e,n>1){const y=l.createChannelSplitter(n),u=l.createChannelMerger(1);v.connect(y);for(let i=0;i<n;i++){const a=l.createGain();a.gain.value=1/n,y.connect(a,i),a.connect(u,0,0)}u.connect(l.destination)}else v.connect(l.destination);v.start(0);try{return await l.startRendering()}catch(y){throw new Error(`Failed to resample audio from ${s}Hz to ${r}Hz: ${y instanceof Error?y.message:String(y)}`)}}function or(e,r){const n=e.length,s=n*2+44,p=new ArrayBuffer(s),l=new DataView(p),v=e.getChannelData(0),y=(i,a)=>{for(let f=0;f<a.length;f++)l.setUint8(i+f,a.charCodeAt(f))};y(0,"RIFF"),l.setUint32(4,s-8,!0),y(8,"WAVE"),y(12,"fmt "),l.setUint32(16,16,!0),l.setUint16(20,1,!0),l.setUint16(22,1,!0),l.setUint32(24,r,!0),l.setUint32(28,r*2,!0),l.setUint16(32,2,!0),l.setUint16(34,16,!0),y(36,"data"),l.setUint32(40,n*2,!0);let u=44;for(let i=0;i<n;i++){const a=Math.max(-1,Math.min(1,v[i]));l.setInt16(u,a*32767,!0),u+=2}return new Blob([p],{type:"audio/wav"})}class ue{constructor(){this.wavesurfer=null,this.currentBlobUrl=null,this.events={},this.isPlaying=!1}initialize(r){this.wavesurfer=r,this.setupEventListeners()}setupEventListeners(){this.wavesurfer&&(this.teardownEventListeners(),this.handleTimeUpdate=r=>{this.events.onTimeUpdate?.(r*1e3)},this.handlePause=()=>{this.isPlaying=!1,this.events.onPause?.()},this.handlePlay=()=>{this.isPlaying=!0,this.events.onPlay?.()},this.handleFinish=()=>{this.isPlaying=!1,this.events.onFinish?.()},this.handleReady=()=>{this.events.onReady?.()},this.handleError=r=>{const o=r instanceof Error?r:new Error(String(r));this.events.onError?.(o)},this.wavesurfer.on("timeupdate",this.handleTimeUpdate),this.wavesurfer.on("pause",this.handlePause),this.wavesurfer.on("play",this.handlePlay),this.wavesurfer.on("finish",this.handleFinish),this.wavesurfer.on("ready",this.handleReady),this.wavesurfer.on("error",this.handleError))}setEventHandlers(r){this.events=r}async load(r){if(!this.wavesurfer)throw new Error("WaveSurfer not initialized");this.cleanupPreviousUrl();let o,n=null;try{if(r instanceof Blob)n=URL.createObjectURL(r),o=n;else if(r instanceof ArrayBuffer){const s=new Blob([r]);n=URL.createObjectURL(s),o=n}else o=r;this.currentBlobUrl=n,await this.wavesurfer.load(o)}catch(s){throw this.cleanupPreviousUrl(),s}}async play(){if(!this.wavesurfer)throw new Error("WaveSurfer not initialized");await this.wavesurfer.play()}pause(){this.wavesurfer&&this.wavesurfer.pause()}getDuration(){return this.wavesurfer?this.wavesurfer.getDuration()*1e3:0}getCurrentTime(){return this.wavesurfer?this.wavesurfer.getCurrentTime()*1e3:0}getIsPlaying(){return this.isPlaying}seekToStart(){this.wavesurfer&&this.wavesurfer.seekTo(0)}cleanupPreviousUrl(){this.currentBlobUrl&&(URL.revokeObjectURL(this.currentBlobUrl),this.currentBlobUrl=null)}destroy(){this.pause(),this.cleanupPreviousUrl(),this.wavesurfer&&(this.teardownEventListeners(),this.wavesurfer.empty(),this.wavesurfer=null),this.events={},this.isPlaying=!1,this.handleTimeUpdate=void 0,this.handlePause=void 0,this.handlePlay=void 0,this.handleFinish=void 0,this.handleReady=void 0,this.handleError=void 0}teardownEventListeners(){this.wavesurfer&&(this.handleTimeUpdate&&(this.wavesurfer.un("timeupdate",this.handleTimeUpdate),this.handleTimeUpdate=void 0),this.handlePause&&(this.wavesurfer.un("pause",this.handlePause),this.handlePause=void 0),this.handlePlay&&(this.wavesurfer.un("play",this.handlePlay),this.handlePlay=void 0),this.handleFinish&&(this.wavesurfer.un("finish",this.handleFinish),this.handleFinish=void 0),this.handleReady&&(this.wavesurfer.un("ready",this.handleReady),this.handleReady=void 0),this.handleError&&(this.wavesurfer.un("error",this.handleError),this.handleError=void 0))}}class sr{constructor(r={}){this.wavesurfer=null,this.recordPlugin=null,this.isRecording=!1,this.recordEndResolve=null,this.recordEndReject=null,this.events={},this.options=r}initialize(r,o){this.wavesurfer=r;try{const n={renderRecordedAudio:!1,mimeType:"audio/webm"};this.recordPlugin=r.registerPlugin(o.create(n)),this.setupEventListeners()}catch(n){const s=n instanceof Error?n:new Error(String(n));throw s.name==="NotAllowedError"||s.name==="PermissionDeniedError"?(this.events.onPermissionDenied?.(),new Error("Microphone permission denied")):(this.events.onError?.(s),s)}}setupEventListeners(){this.recordPlugin&&(this.recordPlugin.on("record-start",()=>{this.isRecording=!0,this.events.onRecordStart?.()}),this.recordPlugin.on("record-end",r=>{this.isRecording=!1,this.events.onRecordEnd?.(r),this.recordEndResolve&&r&&r.size>0?(this.recordEndResolve(r),this.recordEndResolve=null,this.recordEndReject=null):this.recordEndReject?(this.recordEndReject(new Error("Invalid or empty recording")),this.recordEndResolve=null,this.recordEndReject=null):(this.recordEndResolve=null,this.recordEndReject=null)}),this.recordPlugin.on("record-progress",r=>{this.events.onRecordProgress?.(r)}))}setEventHandlers(r){this.events=r}async startRecording(){if(!this.recordPlugin)throw new Error("Record plugin not initialized");if(this.isRecording)return;const r=typeof this.options.sampleRate=="number"?this.options.sampleRate:void 0,o={};r!==void 0&&(o.sampleRate={ideal:r}),await this.startRecordingWithConstraints(o,r!==void 0)}async startRecordingWithConstraints(r,o){if(!this.recordPlugin)throw new Error("Record plugin not initialized");try{const n=Object.keys(r).length?r:void 0;await this.recordPlugin.startRecording(n)}catch(n){const s=n instanceof Error?n:new Error(String(n));if(s.name==="NotAllowedError"||s.name==="PermissionDeniedError")throw this.events.onPermissionDenied?.(),new Error("Microphone permission denied");if(o&&(s.name==="OverconstrainedError"||s.name==="NotReadableError")){this.options.sampleRate=void 0,await this.startRecordingWithConstraints({},!1);return}throw this.events.onError?.(s),s}}async stopRecording(){if(!this.recordPlugin||!this.isRecording)throw new Error("Not currently recording");try{return new Promise((r,o)=>{this.recordEndResolve=r,this.recordEndReject=o,this.recordPlugin?.stopRecording()})}catch(r){const o=r instanceof Error?r:new Error(String(r));throw this.events.onError?.(o),o}}cancelRecording(){this.recordPlugin&&this.isRecording&&(this.recordPlugin.stopRecording(),this.isRecording=!1,this.recordEndResolve=null,this.recordEndReject=null)}destroy(){this.cancelRecording(),this.recordPlugin&&(this.recordPlugin.destroy(),this.recordPlugin=null),this.wavesurfer=null,this.events={}}}const ir=4,ar=4,lr=8,cr=0,dr=4,ur=16e3;function fr({containerRef:e,sampleRate:r,events:o}){const n=Le(),[s,p]=t.useState("idle"),[l,v]=t.useState(null),[y,u]=t.useState(!1),i=t.useRef(null),a=t.useRef(null),f=t.useRef(null),h=t.useRef(o||{}),x=t.useRef(!1),b=t.useRef(new Set),w=t.useRef(!1),F=r===void 0?ur:r;t.useEffect(()=>{h.current=o||{}},[o]);const _=t.useCallback(()=>{const c=Array.from(b.current);b.current.clear(),c.forEach(m=>{m.resolve()})},[]),D=t.useCallback(c=>{u(!1);const m=Array.from(b.current);b.current.clear(),m.forEach(E=>{E.reject(c)})},[]),T=t.useCallback(c=>{const m={onPlay:()=>{u(!0),h.current.onPlaybackPlay?.()},onPause:()=>{u(!1),h.current.onPlaybackPause?.()},onFinish:()=>{u(!1),h.current.onPlaybackFinish?.()},onReady:()=>{_()},onError:E=>{u(!1),D(E),h.current.onError?.(E)}};c.setEventHandlers(m)},[_,D]),P=t.useCallback(async()=>{if(!(x.current||!e.current))try{const[c,m]=await Promise.all([ae(()=>import("./wavesurfer.esm.vI8Eid4k.js"),[],import.meta.url),ae(()=>import("./record.B-tDciZb.js"),[],import.meta.url)]),E=c.default,A=m.default,U=E.create({container:e.current,waveColor:n.colors.primary,progressColor:n.colors.bodyText,height:ze(n.sizes.largestElementHeight)-2*dr,barWidth:ir,barGap:ar,barRadius:lr,cursorWidth:cr,interact:!0});i.current=U,w.current=!1;const H=new sr({sampleRate:F});H.initialize(U,A),H.setEventHandlers({onRecordProgress:j=>{h.current.onProgressMs?.(j)},onPermissionDenied:()=>{h.current.onPermissionDenied?.(),p("idle")},onError:j=>{h.current.onError?.(j),p("idle")}}),a.current=H;const L=new ue;L.initialize(U),f.current=L,T(L),x.current=!0}catch(c){const m=c instanceof Error?c:new Error(String(c));h.current.onError?.(m)}},[e,n,F,T]);t.useEffect(()=>{P();const c=b.current;return()=>{c.clear(),u(!1),a.current&&(a.current.destroy(),a.current=null),f.current&&(f.current.destroy(),f.current=null),i.current&&(i.current.destroy(),i.current=null),x.current=!1,w.current=!1}},[P]),t.useEffect(()=>{const c=i.current;if(c){if(s==="recording"){c.setOptions({waveColor:n.colors.primary,progressColor:n.colors.primary});return}if(w.current){c.setOptions({interact:!0,waveColor:le(n.colors.fadedText40,n.colors.secondaryBg),progressColor:n.colors.bodyText});return}c.setOptions({waveColor:n.colors.primary,progressColor:n.colors.bodyText})}},[s,n.colors.bodyText,n.colors.fadedText40,n.colors.primary,n.colors.secondaryBg]);const R=t.useCallback(async()=>{if(s!=="recording"){if(x.current||await P(),!a.current)throw new Error("Record backend not initialized");i.current&&i.current.setOptions({waveColor:n.colors.primary,progressColor:n.colors.primary}),w.current=!1,await a.current.startRecording(),p("recording"),v(null),u(!1),h.current.onRecordStart?.()}},[s,P,n.colors.primary]),G=t.useCallback(()=>{f.current&&i.current&&(f.current.destroy(),f.current=new ue,f.current.initialize(i.current),b.current.clear(),u(!1),T(f.current)),w.current=!1},[T]),M=t.useCallback(()=>{f.current?.seekToStart(),u(!1),w.current=!0,i.current&&i.current.setOptions({interact:!0,waveColor:le(n.colors.fadedText40,n.colors.secondaryBg),progressColor:n.colors.bodyText})},[n.colors.bodyText,n.colors.fadedText40,n.colors.secondaryBg]),k=t.useCallback(async()=>{if(s!=="recording")throw new Error("Not currently recording");if(!a.current||!f.current)throw new Error("Backends not initialized");try{const c=await a.current.stopRecording();return v(c),await new Promise((m,E)=>{if(!f.current){E(new Error("Player not initialized"));return}const A={resolve:()=>{b.current.delete(A),m()},reject:U=>{b.current.delete(A),E(U)}};b.current.add(A),f.current.load(c).catch(U=>{b.current.delete(A),E(U instanceof Error?U:new Error(String(U)))})}),p("idle"),u(!1),M(),h.current.onRecordReady?.(c),c}catch(c){const m=c instanceof Error?c:new Error(String(c));throw u(!1),m}},[s,M]),V=t.useCallback(async c=>{const m=c??l;if(!m)throw new Error("No recorded audio to approve");try{const E=await tr(m,F);h.current.onApprove?.(E),v(null),p("idle")}catch(E){const A=E instanceof Error?E:new Error(String(E));throw h.current.onError?.(A),A}},[l,F]),N=t.useCallback(()=>{s==="recording"&&a.current?.cancelRecording(),G(),v(null),p("idle"),u(!1),w.current=!1,h.current.onCancel?.()},[s,G]),z={isPlaying:t.useCallback(()=>f.current?.getIsPlaying()??!1,[]),play:t.useCallback(async()=>{if(!f.current)throw new Error("Player not initialized");await f.current.play()},[]),pause:t.useCallback(()=>{f.current?.pause()},[]),load:t.useCallback(async c=>{if(x.current||await P(),!f.current)throw new Error("Player not initialized");await f.current.load(c),M()},[M,P]),getCurrentTimeMs:t.useCallback(()=>f.current?.getCurrentTime()??0,[]),getDurationMs:t.useCallback(()=>f.current?.getDuration()??0,[])},J=t.useCallback(c=>{h.current=c},[]);return{state:s,isPlaybackPlaying:y,start:R,stop:k,approve:V,cancel:N,playback:z,setEventHandlers:J}}const hr=(e,r)=>{const{libConfig:{enforceDownloadInNewTab:o=!1}}=t.useContext(We);return t.useCallback(()=>{if(!e)return;const s=Ye({enforceDownloadInNewTab:o,url:e,filename:r});s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s)},[e,o,r])},Y=({widgetMgr:e,id:r,formId:o,key:n,defaultValue:s})=>{t.useEffect(()=>{const i=e.getElementState(r,n);he(i)&&q(s)&&e.setElementState(r,n,s)},[e,r,n,s]);const[p,l]=t.useState(e.getElementState(r,n)??s),v=t.useCallback(i=>{e.setElementState(r,n,i),l(i)},[e,r,n]),y=t.useMemo(()=>({formId:o||""}),[o]),u=t.useCallback(()=>v(s),[s,v]);return Je({element:y,widgetMgr:e,onFormCleared:u}),[p,v]},pr=async({files:e,uploadClient:r,widgetMgr:o,widgetInfo:n,fragmentId:s,signal:p})=>{let l=[];try{l=await r.fetchFileURLs(e)}catch(i){return{successfulUploads:[],failedUploads:e.map(a=>({file:a,error:ce(i)}))}}const v=Me(e,l),y=[],u=[];return await Promise.all(v.map(async([i,a])=>{if(!i||!a?.uploadUrl||!a.fileId)return{file:i,fileUrl:a,error:new Error("No upload URL found")};try{await r.uploadFile({id:a.fileId,formId:n.formId||""},a.uploadUrl,i,void 0,p),y.push({fileUrl:a,file:i})}catch(f){const h=ce(f);u.push({file:i,error:h})}})),o.setFileUploaderStateValue(n,new Oe({uploadedFileInfo:y.map(({file:i,fileUrl:a})=>new _e({fileId:a.fileId,fileUrls:a,name:i.webkitRelativePath||i.name,size:i.size}))}),{fromUi:!0},s),{successfulUploads:y,failedUploads:u}},gr=C("div",{target:"e3q8yfp0"})(),fe=C("div",{target:"e3q8yfp1"})(({theme:e,disabled:r})=>({height:e.sizes.largestElementHeight,width:"100%",background:e.colors.secondaryBg,borderRadius:e.radii.default,marginBottom:e.spacing.twoXS,display:"flex",alignItems:"center",position:"relative",paddingLeft:e.spacing.xs,paddingRight:e.spacing.sm,border:e.colors.widgetBorderColor?`${e.sizes.borderWidth} solid ${e.colors.widgetBorderColor}`:void 0,cursor:r?"not-allowed":"auto",overflow:"hidden"})),yr=C("div",{target:"e3q8yfp2"})({flex:1}),vr=C("div",{target:"e3q8yfp3"})(({show:e,theme:r})=>({display:e?"block":"none",position:"relative",height:r.sizes.largestElementHeight,"& > div":{position:"absolute",top:0,left:0,width:"100%",height:"100%",display:"flex",alignItems:"center"}})),wr=C("span",{target:"e3q8yfp4"})(({theme:e,isPlayingOrRecording:r,disabled:o})=>({margin:e.spacing.sm,fontFamily:e.fonts.monospace,color:o?e.colors.fadedText40:r?e.colors.bodyText:e.colors.fadedText60,backgroundColor:e.colors.secondaryBg,fontSize:e.fontSizes.sm})),me=C("div",{target:"e3q8yfp5"})({width:"100%",textAlign:"center",overflow:"hidden"}),Ee=C("span",{target:"e3q8yfp6"})(({theme:e})=>({color:e.colors.bodyText})),mr=C("a",{target:"e3q8yfp7"})(({theme:e})=>({color:e.colors.link,textDecoration:e.linkUnderline?"underline":"none"})),Er=C("div",{target:"e3q8yfp8"})(({theme:e})=>({flex:1,height:e.sizes.largestElementHeight,display:"flex",justifyContent:"center",alignItems:"center"})),Rr=C("div",{target:"e3q8yfp9"})(({theme:e})=>{const r="0.625em";return{opacity:.2,width:"100%",height:r,backgroundSize:r,backgroundImage:`radial-gradient(${e.colors.fadedText10} 40%, transparent 40%)`,backgroundRepeat:"repeat"}}),br=C("span",{target:"e3q8yfp10"})(({theme:e})=>({"& > button":{color:e.colors.primary,padding:e.spacing.threeXS},"& > button:hover, & > button:focus":{color:e.colors.redColor}})),Cr=C("span",{target:"e3q8yfp11"})(({theme:e})=>({"& > button":{padding:e.spacing.threeXS,color:e.colors.fadedText60},"& > button:hover, & > button:focus":{color:e.colors.bodyText}})),Re=C("span",{target:"e3q8yfp12"})(({theme:e})=>({"& > button":{padding:e.spacing.threeXS,color:e.colors.fadedText60},"& > button:hover, & > button:focus":{color:e.colors.bodyText}})),ee=C("div",{target:"e3q8yfp13"})(({theme:e})=>({display:"flex",justifyContent:"center",alignItems:"center",flexGrow:0,flexShrink:1,padding:e.spacing.xs,gap:e.spacing.twoXS,marginRight:e.spacing.twoXS})),Pr=C("div",{target:"e3q8yfp14"})(({theme:e})=>({marginLeft:e.spacing.sm})),X=({onClick:e,disabled:r,ariaLabel:o,iconContent:n})=>d(je,{kind:Ne.BORDERLESS_ICON,onClick:e,disabled:r,"aria-label":o,containerWidth:!0,"data-testid":"stAudioInputActionButton",children:d(He,{content:n,size:"lg",color:"inherit"})}),Sr=({disabled:e,stopRecording:r})=>d(br,{children:d(X,{onClick:r,disabled:e,ariaLabel:"Stop recording",iconContent:we})}),kr=({disabled:e,isPlaying:r,onClickPlayPause:o})=>d(Re,{children:r?d(X,{onClick:o,disabled:e,ariaLabel:"Pause",iconContent:ge}):d(X,{onClick:o,disabled:e,ariaLabel:"Play",iconContent:ye})}),Ar=({disabled:e,startRecording:r})=>d(Cr,{children:d(X,{onClick:r,disabled:e,ariaLabel:"Record",iconContent:pe})}),Ur=({onClick:e})=>d(Re,{children:d(X,{disabled:!1,onClick:e,ariaLabel:"Reset",iconContent:ve})}),Tr=({disabled:e,isRecording:r,isPlaying:o,isUploading:n,isError:s,recordingUrlExists:p,startRecording:l,stopRecording:v,onClickPlayPause:y,onClear:u})=>s?d(ee,{children:d(Ur,{onClick:u})}):n?d(ee,{children:d(Ve,{"aria-label":"Uploading",size:"base",margin:"0",padding:"0"})}):$(ee,{children:[r?d(Sr,{disabled:e,stopRecording:v}):d(Ar,{disabled:e,startRecording:l}),p&&d(kr,{disabled:e,isPlaying:o,onClickPlayPause:y})]}),Ir=t.memo(Tr),xr=()=>d(me,{children:d(Ee,{children:"An error has occurred, please try again."})}),Br=t.memo(xr),B="00:00",O=e=>{const r=Math.floor(e/1e3),o=Math.floor(r/60),n=Math.floor(o/60),s=r%60,p=o%60,l=s.toString().padStart(2,"0"),v=p.toString().padStart(2,"0"),y=n.toString().padStart(2,"0");return o<60?`${v}:${l}`:`${y}:${v}:${l}`},Fr=()=>$(me,{children:[d(Ee,{children:"This app would like to use your microphone."})," ",d(mr,{href:qe,rel:"noopener noreferrer",target:"_blank",children:"Learn how to allow access."})]}),Dr=t.memo(Fr),Lr=()=>d(Er,{children:d(Rr,{})}),zr=t.memo(Lr),Wr=({element:e,uploadClient:r,widgetMgr:o,fragmentId:n,disabled:s})=>{const p=t.useRef(null),[l,v]=t.useState(!1),[y,u]=t.useState(!1),[i,a]=t.useState(!1),[f,h]=t.useState(B),[x,b]=Y({widgetMgr:o,id:e.id,key:"deleteFileUrl",defaultValue:null}),[w,F]=Y({widgetMgr:o,id:e.id,key:"recordingUrl",defaultValue:null}),[_,D]=Y({widgetMgr:o,id:e.id,formId:e.formId,key:"recordingTime",defaultValue:B}),T=t.useRef(null),P=t.useRef(null),R=t.useRef(null),G=t.useRef(),M=e.id,k=e.formId,V=fr({containerRef:p,sampleRate:e.sampleRate??void 0,events:{onPermissionDenied:()=>{v(!0)},onError:()=>{a(!0)},onRecordStart:()=>{D(B),h(B)},onRecordReady:()=>{const g=O(V.playback.getDurationMs());D(g),h(g)},onApprove:g=>{G.current?.(g)},onCancel:()=>{D(B),h(B)},onProgressMs:g=>{D(O(g))},onPlaybackPause:()=>{h(O(V.playback.getCurrentTimeMs()))},onPlaybackFinish:()=>{h(O(V.playback.getDurationMs()))}}}),{state:N,isPlaybackPlaying:z,start:J,stop:c,approve:m,cancel:E,playback:{play:A,pause:U,load:H,getCurrentTimeMs:L,getDurationMs:j}}=V,be=t.useCallback(async g=>{T.current&&T.current.abort();const I=new AbortController;T.current=I;try{if(u(!0),q(k)&&o.setFormsWithUploadsInProgress(new Set([k])),I.signal.aborted)return;let S;try{S=URL.createObjectURL(g),P.current&&P.current!==S&&URL.revokeObjectURL(P.current),P.current=S}catch{a(!0),u(!1),q(k)&&o.setFormsWithUploadsInProgress(new Set);return}if(I.signal.aborted){URL.revokeObjectURL(S),P.current=null;return}F(S);const xe=new Date().toISOString().slice(0,16).replace(/:/g,"-"),Be=new File([g],`${xe}_audio.wav`,{type:g.type});try{const{successfulUploads:Fe,failedUploads:De}=await pr({files:[Be],uploadClient:r,widgetMgr:o,widgetInfo:{id:M,formId:k},fragmentId:n,signal:I.signal});if(I.signal.aborted)return;if(De.length>0){a(!0);return}a(!1);const ie=Fe[0];ie?.fileUrl?.deleteUrl&&b(ie.fileUrl.deleteUrl)}catch{I.signal.aborted||a(!0)}finally{q(k)&&o.setFormsWithUploadsInProgress(new Set),I.signal.aborted||u(!1)}}catch{I.signal.aborted||(a(!0),u(!1)),q(k)&&o.setFormsWithUploadsInProgress(new Set)}},[r,o,M,k,n,b,F]);G.current=be;const W=t.useCallback(async({updateWidgetManager:g,deleteFile:I})=>{const S=w;if(S&&P.current===S&&(URL.revokeObjectURL(S),P.current=null),R.current&&(cancelAnimationFrame(R.current),R.current=null),F(null),b(null),h(B),D(B),E(),g&&o.setFileUploaderStateValue(e,{},{fromUi:!0},n),I&&x)try{await r.deleteFile(x)}catch{}q(S)&&URL.revokeObjectURL(S)},[x,w,r,E,e,o,n,D,b,F]);t.useEffect(()=>{const g=()=>{z&&(h(O(L())),R.current=requestAnimationFrame(g))};return z?R.current=requestAnimationFrame(g):R.current&&(cancelAnimationFrame(R.current),R.current=null),()=>{R.current&&(cancelAnimationFrame(R.current),R.current=null)}},[z,L]),t.useEffect(()=>{if(!w)return;let g=!1;return h(_),(async()=>{try{if(await H(w),g)return;const S=j();S>0&&h(O(S))}catch{g||a(!0)}})(),()=>{g=!0}},[w,_,H,j]),t.useEffect(()=>{if(he(k))return;const g=new Qe;return g.manageFormClearListener(o,k,()=>{W({updateWidgetManager:!0,deleteFile:!1})}),()=>g.disconnect()},[k,W,o]),t.useEffect(()=>()=>{T.current&&(T.current.abort(),T.current=null),R.current&&(cancelAnimationFrame(R.current),R.current=null)},[]);const Ce=t.useCallback(async()=>{try{if(z){const g=L();U(),h(O(g))}else N==="idle"&&w&&(L()<=100&&h(B),await A())}catch{a(!0)}},[z,L,U,A,w,N]),re=t.useCallback(async()=>{w&&await W({updateWidgetManager:!1,deleteFile:!0});try{h(B),await J()}catch{}},[W,w,J]),te=t.useCallback(async()=>{try{const g=await c();await m(g)}catch{a(!0)}},[m,c]),ne=hr(w,"recording.wav"),Pe=t.useCallback(()=>{re()},[re]),Se=t.useCallback(()=>{te()},[te]),ke=t.useCallback(()=>{W({updateWidgetManager:!1,deleteFile:!0}),a(!1)},[W]),Ae=t.useCallback(()=>{ne()},[ne]),Ue=t.useCallback(()=>{W({updateWidgetManager:!0,deleteFile:!0})},[W]),Q=N==="recording",oe=z,Te=Q?_:f,se=N==="idle"&&!l&&!w,Ie=l||se||i;return $(gr,{className:"stAudioInput","data-testid":"stAudioInput",children:[d(Ze,{label:e.label,disabled:s,labelVisibility:$e(e.labelVisibility?.value),children:e.help&&d(Pr,{children:d(Ge,{content:e.help,placement:Xe.TOP})})}),$(fe,{disabled:s,children:[$(Ke,{isFullScreen:!1,disableFullscreenMode:!0,target:fe,children:[w&&d(de,{label:"Download as WAV",icon:er,onClick:Ae}),x&&d(de,{label:"Clear recording",icon:rr,onClick:Ue})]}),d(Ir,{isRecording:Q,isPlaying:oe,isUploading:y,isError:i,recordingUrlExists:!!w,startRecording:Pe,stopRecording:Se,onClickPlayPause:()=>void Ce(),onClear:ke,disabled:s||l}),$(yr,{children:[i&&d(Br,{}),se&&d(zr,{}),l&&d(Dr,{}),d(vr,{"data-testid":"stAudioInputWaveSurfer",ref:p,show:!Ie})]}),d(wr,{isPlayingOrRecording:Q||oe,disabled:s,"data-testid":"stAudioInputWaveformTimeCode",children:Te})]})]})},Hr=t.memo(Wr);export{Hr as default};
