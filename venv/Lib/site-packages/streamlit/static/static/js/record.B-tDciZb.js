function w(m,t,i,e){return new(i||(i=Promise))(function(o,r){function s(h){try{a(e.next(h))}catch(d){r(d)}}function n(h){try{a(e.throw(h))}catch(d){r(d)}}function a(h){var d;h.done?o(h.value):(d=h.value,d instanceof i?d:new i(function(v){v(d)})).then(s,n)}a((e=e.apply(m,[])).next())})}class g{constructor(){this.listeners={}}on(t,i,e){if(this.listeners[t]||(this.listeners[t]=new Set),this.listeners[t].add(i),e?.once){const o=()=>{this.un(t,o),this.un(t,i)};return this.on(t,o),o}return()=>this.un(t,i)}un(t,i){var e;(e=this.listeners[t])===null||e===void 0||e.delete(i)}once(t,i){return this.on(t,i,{once:!0})}unAll(){this.listeners={}}emit(t,...i){this.listeners[t]&&this.listeners[t].forEach(e=>e(...i))}}class R extends g{constructor(t){super(),this.subscriptions=[],this.isDestroyed=!1,this.options=t}onInit(){}_init(t){this.isDestroyed&&(this.subscriptions=[],this.isDestroyed=!1),this.wavesurfer=t,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach(t=>t()),this.subscriptions=[],this.isDestroyed=!0,this.wavesurfer=void 0}}class b extends g{constructor(){super(...arguments),this.unsubscribe=()=>{}}start(){this.unsubscribe=this.on("tick",()=>{requestAnimationFrame(()=>{this.emit("tick")})}),this.emit("tick")}stop(){this.unsubscribe()}destroy(){this.unsubscribe()}}const D=["audio/webm","audio/wav","audio/mpeg","audio/mp4","audio/mp3"];class W extends R{constructor(t){var i,e,o,r,s,n;super(Object.assign(Object.assign({},t),{audioBitsPerSecond:(i=t.audioBitsPerSecond)!==null&&i!==void 0?i:128e3,scrollingWaveform:(e=t.scrollingWaveform)!==null&&e!==void 0&&e,scrollingWaveformWindow:(o=t.scrollingWaveformWindow)!==null&&o!==void 0?o:5,continuousWaveform:(r=t.continuousWaveform)!==null&&r!==void 0&&r,renderRecordedAudio:(s=t.renderRecordedAudio)===null||s===void 0||s,mediaRecorderTimeslice:(n=t.mediaRecorderTimeslice)!==null&&n!==void 0?n:void 0})),this.stream=null,this.mediaRecorder=null,this.dataWindow=null,this.isWaveformPaused=!1,this.lastStartTime=0,this.lastDuration=0,this.duration=0,this.timer=new b,this.subscriptions.push(this.timer.on("tick",()=>{const a=performance.now()-this.lastStartTime;this.duration=this.isPaused()?this.duration:this.lastDuration+a,this.emit("record-progress",this.duration)}))}static create(t){return new W(t||{})}renderMicStream(t){var i;const e=new AudioContext,o=e.createMediaStreamSource(t),r=e.createAnalyser();o.connect(r),this.options.continuousWaveform&&(r.fftSize=32);const s=r.frequencyBinCount,n=new Float32Array(s);let a=0;this.wavesurfer&&((i=this.originalOptions)!==null&&i!==void 0||(this.originalOptions=Object.assign({},this.wavesurfer.options)),this.wavesurfer.options.interact=!1,this.options.scrollingWaveform&&(this.wavesurfer.options.cursorWidth=0));const h=setInterval(()=>{var d,v,p,f;if(!this.isWaveformPaused){if(r.getFloatTimeDomainData(n),this.options.scrollingWaveform){const c=Math.floor((this.options.scrollingWaveformWindow||0)*e.sampleRate),u=Math.min(c,this.dataWindow?this.dataWindow.length+s:s),l=new Float32Array(c);if(this.dataWindow){const y=Math.max(0,c-this.dataWindow.length);l.set(this.dataWindow.slice(-u+s),y)}l.set(n,c-s),this.dataWindow=l}else if(this.options.continuousWaveform){if(!this.dataWindow){const u=this.options.continuousWaveformDuration?Math.round(100*this.options.continuousWaveformDuration):((v=(d=this.wavesurfer)===null||d===void 0?void 0:d.getWidth())!==null&&v!==void 0?v:0)*window.devicePixelRatio;this.dataWindow=new Float32Array(u)}let c=0;for(let u=0;u<s;u++){const l=Math.abs(n[u]);l>c&&(c=l)}if(a+1>this.dataWindow.length){const u=new Float32Array(2*this.dataWindow.length);u.set(this.dataWindow,0),this.dataWindow=u}this.dataWindow[a]=c,a++}else this.dataWindow=n;if(this.wavesurfer){const c=((f=(p=this.dataWindow)===null||p===void 0?void 0:p.length)!==null&&f!==void 0?f:0)/100;this.wavesurfer.load("",[this.dataWindow],this.options.scrollingWaveform?this.options.scrollingWaveformWindow:c).then(()=>{this.wavesurfer&&this.options.continuousWaveform&&(this.wavesurfer.setTime(this.getDuration()/1e3),this.wavesurfer.options.minPxPerSec||this.wavesurfer.setOptions({minPxPerSec:this.wavesurfer.getWidth()/this.wavesurfer.getDuration()}))}).catch(u=>{console.error("Error rendering real-time recording data:",u)})}}},10);return{onDestroy:()=>{clearInterval(h),o?.disconnect(),e?.close()},onEnd:()=>{this.isWaveformPaused=!0,clearInterval(h),this.stopMic()}}}startMic(t){return w(this,void 0,void 0,function*(){let i;try{i=yield navigator.mediaDevices.getUserMedia({audio:t==null||t})}catch(r){throw new Error("Error accessing the microphone: "+r.message)}const{onDestroy:e,onEnd:o}=this.renderMicStream(i);return this.subscriptions.push(this.once("destroy",e)),this.subscriptions.push(this.once("record-end",o)),this.stream=i,i})}stopMic(){this.stream&&(this.stream.getTracks().forEach(t=>t.stop()),this.stream=null,this.mediaRecorder=null)}startRecording(t){return w(this,void 0,void 0,function*(){const i=this.stream||(yield this.startMic(t));this.dataWindow=null;const e=this.mediaRecorder||new MediaRecorder(i,{mimeType:this.options.mimeType||D.find(s=>MediaRecorder.isTypeSupported(s)),audioBitsPerSecond:this.options.audioBitsPerSecond});this.mediaRecorder=e,this.stopRecording();const o=[];e.ondataavailable=s=>{s.data.size>0&&o.push(s.data),this.emit("record-data-available",s.data)};const r=s=>{var n;const a=new Blob(o,{type:e.mimeType});this.emit(s,a),this.options.renderRecordedAudio&&(this.applyOriginalOptionsIfNeeded(),(n=this.wavesurfer)===null||n===void 0||n.load(URL.createObjectURL(a)))};e.onpause=()=>r("record-pause"),e.onstop=()=>r("record-end"),e.start(this.options.mediaRecorderTimeslice),this.lastStartTime=performance.now(),this.lastDuration=0,this.duration=0,this.isWaveformPaused=!1,this.timer.start(),this.emit("record-start")})}getDuration(){return this.duration}isRecording(){var t;return((t=this.mediaRecorder)===null||t===void 0?void 0:t.state)==="recording"}isPaused(){var t;return((t=this.mediaRecorder)===null||t===void 0?void 0:t.state)==="paused"}isActive(){var t;return((t=this.mediaRecorder)===null||t===void 0?void 0:t.state)!=="inactive"}stopRecording(){var t;this.isActive()&&((t=this.mediaRecorder)===null||t===void 0||t.stop(),this.timer.stop())}pauseRecording(){var t,i;this.isRecording()&&(this.isWaveformPaused=!0,(t=this.mediaRecorder)===null||t===void 0||t.requestData(),(i=this.mediaRecorder)===null||i===void 0||i.pause(),this.timer.stop(),this.lastDuration=this.duration)}resumeRecording(){var t;this.isPaused()&&(this.isWaveformPaused=!1,(t=this.mediaRecorder)===null||t===void 0||t.resume(),this.timer.start(),this.lastStartTime=performance.now(),this.emit("record-resume"))}static getAvailableAudioDevices(){return w(this,void 0,void 0,function*(){return navigator.mediaDevices.enumerateDevices().then(t=>t.filter(i=>i.kind==="audioinput"))})}destroy(){this.applyOriginalOptionsIfNeeded(),super.destroy(),this.stopRecording(),this.stopMic()}applyOriginalOptionsIfNeeded(){this.wavesurfer&&this.originalOptions&&(this.wavesurfer.setOptions(this.originalOptions),delete this.originalOptions)}}export{W as default};
